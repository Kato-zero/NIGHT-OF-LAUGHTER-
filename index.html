<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NIGHT OF LAUGHTER — Buy Tickets</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <style>
    /* keep your CSS mostly as-is (trimmed here for brevity) */
    :root{--blue:#007bff;--deep-blue:#1176d6;--gray-bg:#f2f2f2;--white:#fff;--black:#333;--offwhite:#f9f9f9}
    html,body{margin:0;padding:0;font-family:system-ui,Arial,sans-serif;background:var(--gray-bg);color:var(--black)}
    header{width:100%;background:var(--white);padding:15px 5vw;display:flex;justify-content:space-between;align-items:center;position:fixed;top:0;left:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,0.08)}
    .header-logo{height:55px}
    .hero{width:100%;height:60vh;min-height:290px;background:url('https://i.postimg.cc/wM34b68W/1763283904035-1.jpg') center/cover no-repeat;display:flex;justify-content:center;align-items:center;text-align:center;padding:0 7vw;margin-top:65px}
    .wrap{max-width:1100px;margin:24px auto;padding:20px}
    .event-list{display:flex;flex-wrap:wrap;gap:2vw;justify-content:center}
    .event-card{width:100%;max-width:360px;background:var(--white);border-radius:12px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.08);margin:24px;display:flex;flex-direction:column}
    .event-thumb{width:100%;aspect-ratio:1/1;background:#eee;display:flex;align-items:center;justify-content:center}
    .event-thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .event-content{padding:14px;display:flex;flex-direction:column;gap:8px}
    .price-box{margin-top:8px;padding:10px;background:var(--offwhite);border-radius:8px;font-size:0.95em}
    .btn{padding:10px 12px;background:var(--blue);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.secondary{background:#444}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:3000;justify-content:center;align-items:center}
    .modal-content{background:#fff;padding:18px;border-radius:12px;width:95%;max-width:440px;position:relative}
    .close{position:absolute;right:12px;top:8px;font-size:26px;cursor:pointer}
    .field{display:flex;flex-direction:column;margin-bottom:8px}
    input,select,textarea{padding:9px;border-radius:8px;border:1px solid #ddd;font-size:14px}
    footer{padding:20px;text-align:center;color:#ccc;background:#222;margin-top:30px}
    @media(max-width:700px){.event-card{margin:12px 0}}
  </style>

  <!-- QR library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:12px">
      <img src="logo.png" alt="logo" class="header-logo" />
      <strong>NIGHT OF LAUGHTER</strong>
    </div>
    <nav>
      <a href="#featured">Featured</a>
      <a href="#upcoming">Events</a>
      <a href="#contact">Contact</a>
    </nav>
  </header>

  <main class="wrap" style="margin-top:120px">
    <section id="featured"></section>

    <section id="upcoming">
      <h2>Upcoming Events</h2>
      <div id="eventsList" class="event-list"></div>
      <div id="eventsEmpty" style="display:none;color:#666">No events available right now.</div>
    </section>
  </main>

  <!-- BUY TICKET MODAL -->
  <div id="ticketModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content" id="ticketModalContent">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 id="modalEventName">Event</h3>
      <img id="modalEventImage" src="" alt="" style="width:100%;height:160px;object-fit:cover;border-radius:8px;margin-bottom:10px" loading="lazy">
      <form id="ticketForm">
        <div class="field">
          <label for="buyerName">Name</label>
          <input id="buyerName" required />
        </div>
        <div class="field">
          <label for="buyerPhone">Phone</label>
          <input id="buyerPhone" required placeholder="0971234567 or 260971234567" />
        </div>
        <div class="field">
          <label for="ticketType">Ticket Type</label>
          <select id="ticketType"></select>
        </div>
        <div class="field">
          <label for="ticketPrice">Price (ZMW)</label>
          <input id="ticketPrice" type="number" required readonly />
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button type="button" id="payMtn" class="btn">Pay with MTN</button>
          <button type="button" id="payAirtel" class="btn" style="background:#0b7a3b">Pay with Airtel</button>
        </div>

        <div style="margin-top:10px">
          <button type="button" id="whatsappBook" class="btn" style="background:#25D366">Book via WhatsApp</button>
          <button type="button" onclick="closeModal()" class="btn secondary" style="margin-left:8px">Cancel</button>
        </div>

        <p id="paymentStatus" style="margin-top:8px;color:#333;font-weight:600"></p>
      </form>
    </div>
  </div>

  <!-- TICKET RESULT -->
  <div id="ticketResultModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeTicketResult()">&times;</span>
      <h3>Your ticket</h3>
      <div id="ticketQRArea" style="text-align:center;margin:12px 0"></div>
      <a id="downloadTicket" class="btn" download="ticket.png">Download Ticket</a>
    </div>
  </div>

  <footer id="contact">NIGHT OF LAUGHTER © 2025</footer>

<script>
/* ---------- CONFIG ---------- */
const API_BASE = "https://night-of-laughter-ticket-backend-1.onrender.com"; // change here if needed
const EVENTS_URL = `${API_BASE}/api/events`;
const CREATE_PAYMENT_URL = `${API_BASE}/api/create-payment`;
const ORDER_STATUS_URL = id => `${API_BASE}/api/order/${id}`; // backend: GET /api/order/:id

/* ---------- STATE ---------- */
let events = [];
let currentEvent = null;
let currentTicketPayload = null;

/* ---------- HELPERS ---------- */
function el(sel){ return document.querySelector(sel); }
function escapetext(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

function normalizePhoneToInternational(input){
  if(!input) return '';
  let s = input.trim().replace(/[\s\-]/g,'');
  if(s.startsWith('+')) s = s.slice(1);
  if(/^0\d{8,9}$/.test(s)) return '260' + s.slice(1);
  if(/^\d{9,12}$/.test(s) && s.startsWith('260')) return s;
  if(/^\d{9}$/.test(s)) return '260' + s;
  return s;
}

/* ---------- RENDERING ---------- */
function renderEventCard(ev){
  const img = ev.posterUrl || ev.image || 'https://via.placeholder.com/400x400';
  const priceText = ev.price ? `ZMW ${ev.price}` : 'Price TBA';
  return `
    <div class="event-card" role="article">
      <div class="event-thumb"><img src="${escapetext(img)}" alt="${escapetext(ev.name)}"></div>
      <div class="event-content">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">${escapetext(ev.name)}</div>
          <div style="font-size:0.9rem;color:#666">${escapetext(ev.date || '')}</div>
        </div>
        <div style="font-size:0.95rem;color:#333">${escapetext(ev.venue || '')}</div>
        <div class="price-box">${priceText}</div>
        <div class="btn-row" style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" onclick="openBuyModal('${ev._id}')">Buy Ticket</button>
          <button class="btn secondary" onclick="openMore('${ev._id}')">More Info</button>
        </div>
      </div>
    </div>
  `;
}

function renderEvents(){
  const list = el('#eventsList');
  if(!events.length){
    el('#eventsEmpty').style.display = 'block';
    list.innerHTML = '';
    return;
  }
  el('#eventsEmpty').style.display = 'none';
  list.innerHTML = events.map(renderEventCard).join('');
}

/* ---------- DATA ---------- */
async function fetchEvents(){
  try {
    const r = await fetch(EVENTS_URL);
    if(!r.ok) throw new Error('Failed to fetch events: ' + r.status);
    events = await r.json();
    renderEvents();
  } catch (err){
    console.error(err);
    el('#eventsList').innerHTML = `<div style="color:#a00">Error loading events. See console.</div>`;
  }
}

/* ---------- UI ACTIONS ---------- */
function openMore(id){
  const ev = events.find(e=>e._id === id);
  if(!ev) return alert('Event not found');
  alert(`${ev.name}\n\n${ev.desc || ''}\n\nVenue: ${ev.venue}\nDate: ${ev.date}\nPrice: ${ev.price || 'TBA'}`);
}

function openBuyModal(id){
  const ev = events.find(e=>e._id === id);
  if(!ev) return alert('Event not found');
  currentEvent = ev;
  el('#modalEventName').textContent = ev.name;
  el('#modalEventImage').src = ev.posterUrl || ev.image || 'https://via.placeholder.com/400x400';
  el('#ticketPrice').value = ev.price || 0;
  // populate ticket types (if you used ticketTypes in model you can adapt)
  const ticketTypeSelect = el('#ticketType');
  ticketTypeSelect.innerHTML = '';
  // default single option
  ticketTypeSelect.appendChild(new Option('Standard', 'standard'));
  // open modal
  el('#ticketModal').style.display = 'flex';
  el('#buyerName').focus();
  el('#paymentStatus').textContent = '';
}

function closeModal(){
  el('#ticketModal').style.display = 'none';
}

/* ---------- PAYMENT FLOW ---------- */
async function startPayment(provider){
  if(!currentEvent) return alert('No event selected');
  const name = el('#buyerName').value.trim();
  const phoneRaw = el('#buyerPhone').value.trim();
  const phone = normalizePhoneToInternational(phoneRaw);
  const price = Number(el('#ticketPrice').value) || 0;
  if(!name || !phone) return alert('Please enter name and phone');
  if(!price || price <= 0) return alert('Invalid ticket price');

  // create payload
  const payload = {
    amount: price,
    phone,
    provider: provider === 'mtn' ? 'MTN' : 'AirtelMoney',
    eventId: currentEvent._id,
    eventName: currentEvent.name,
    buyerName: name
  };

  el('#paymentStatus').textContent = 'Initiating payment...';

  try {
    const resp = await fetch(CREATE_PAYMENT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await resp.json();
    if(!resp.ok){
      el('#paymentStatus').textContent = 'Payment failed: ' + (j.error || j.message || JSON.stringify(j));
      console.error('create-payment error', j);
      return;
    }

    // We created a ticket record; backend returns orderId (ticket id)
    const orderId = j.orderId || j.id || j._id || null;
    if(!orderId) {
      el('#paymentStatus').textContent = 'Payment started but no order id returned. Check admin.';
      return;
    }

    el('#paymentStatus').textContent = 'Payment initiated. Waiting for confirmation... (Order: ' + orderId + ')';

    // poll order status
    const poll = setInterval(async ()=>{
      try {
        const s = await fetch(ORDER_STATUS_URL(orderId));
        if(!s.ok) return;
        const st = await s.json();
        // st.status expected: pending, paid, failed
        if(st.status === 'paid' || (st.providerStatus && /paid|success|completed/i.test(st.providerStatus))){
          clearInterval(poll);
          el('#paymentStatus').textContent = 'Payment confirmed — generating ticket...';
          // prepare ticket payload for QR + image
          currentTicketPayload = {
            event: currentEvent.name,
            name,
            phone,
            type: el('#ticketType').value,
            price,
            receiptNum: st.receiptNum || st.providerReference || ('NOL-' + Date.now())
          };
          // show ticket result modal + generate QR
          showTicketResult(currentTicketPayload);
          closeModal();
        } else if(st.status === 'failed' || (st.providerStatus && /fail|rejected|cancel/i.test(st.providerStatus))){
          clearInterval(poll);
          el('#paymentStatus').textContent = 'Payment failed or cancelled';
        } else {
          // still pending
          el('#paymentStatus').textContent = 'Waiting for payment... (status: ' + (st.status || 'pending') + ')';
        }
      } catch (err){
        console.error('poll error', err);
      }
    }, 3000);

  } catch (err){
    console.error('startPayment error', err);
    el('#paymentStatus').textContent = 'Payment initiation error: ' + err.message;
  }
}

/* ---------- TICKET RESULT ---------- */
function showTicketResult(payload){
  el('#ticketQRArea').innerHTML = '';
  new QRCode(el('#ticketQRArea'), {
    text: JSON.stringify(payload),
    width: 200, height: 200,
    colorDark: "#1c6ef2", colorLight: "#fff"
  });
  el('#ticketResultModal').style.display = 'flex';

  // Create downloadable image
  const downloadBtn = el('#downloadTicket');
  downloadBtn.onclick = () => {
    generateTicketImage(payload, (dataUrl)=>{
      downloadBtn.href = dataUrl;
    });
  };
}

/* Generate a simple ticket image on a canvas and call callback with dataURL */
function generateTicketImage(payload, cb){
  const canvas = document.createElement('canvas');
  canvas.width = 600; canvas.height = 900;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#1176d6'; ctx.fillRect(0,0,canvas.width,120);
  ctx.fillStyle = '#fff'; ctx.font = 'bold 26px Arial'; ctx.fillText('NIGHT OF LAUGHTER', 20, 70);
  ctx.fillStyle = '#333'; ctx.font = '18px Arial';
  ctx.fillText('Event: ' + payload.event, 20, 150);
  ctx.fillText('Name: ' + payload.name, 20, 180);
  ctx.fillText('Phone: ' + payload.phone, 20, 210);
  ctx.fillText('Type: ' + payload.type, 20, 240);
  ctx.fillText('Price: ZMW ' + payload.price, 20, 270);
  ctx.fillText('Receipt: ' + payload.receiptNum, 20, 300);

  // draw QR in a temp div then transfer to image
  const tmp = document.createElement('div');
  tmp.style.display = 'none';
  document.body.appendChild(tmp);
  new QRCode(tmp, { text: JSON.stringify(payload), width: 180, height: 180 });
  const img = tmp.querySelector('img') || tmp.querySelector('canvas');
  if(img){
    const qrImg = new Image();
    qrImg.onload = function(){
      ctx.drawImage(qrImg, canvas.width - 220, 320, 180, 180);
      const dataUrl = canvas.toDataURL('image/png');
      document.body.removeChild(tmp);
      if(cb) cb(dataUrl);
    };
    qrImg.src = img.src;
  } else {
    const dataUrl = canvas.toDataURL('image/png');
    document.body.removeChild(tmp);
    if(cb) cb(dataUrl);
  }
}

function closeTicketResult(){
  el('#ticketResultModal').style.display = 'none';
}

/* ---------- BUTTON HOOKS ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // load events
  fetchEvents();

  // payment buttons
  el('#payMtn').addEventListener('click', ()=> startPayment('mtn'));
  el('#payAirtel').addEventListener('click', ()=> startPayment('airtel'));
  el('#whatsappBook').addEventListener('click', ()=>{
    // open whatsapp with payload
    const name = el('#buyerName').value.trim(), phone = el('#buyerPhone').value.trim(), type = el('#ticketType').value;
    const price = el('#ticketPrice').value;
    if(!name || !phone) return alert('Enter name and phone to book via WhatsApp');
    const payload = { event: currentEvent?.name || '', name, phone, type, price, receiptNum: 'NOL-' + Date.now() };
    const msg = encodeURIComponent(
      `Booking request\nEvent: ${payload.event}\nName: ${payload.name}\nPhone: ${payload.phone}\nType: ${payload.type}\nPrice: ${payload.price}\nReceipt: ${payload.receiptNum}`
    );
    window.open(`https://wa.me/260973299759?text=${msg}`, '_blank');
  });

  // close modals on background click
  window.addEventListener('click', (e)=>{
    ['ticketModal','ticketResultModal'].forEach(id=>{
      const m = el('#'+id);
      if(m && e.target === m) m.style.display = 'none';
    });
  });
});

/* ---------- EXPORT (for debugging) ---------- */
window._nol = { API_BASE, EVENTS_URL, CREATE_PAYMENT_URL, ORDER_STATUS_URL };
</script>
</body>
    </html>
